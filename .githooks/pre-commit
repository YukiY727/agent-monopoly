#!/bin/bash

# ãƒ¢ãƒãƒãƒªãƒ¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ pre-commit hook
# ãƒ­ãƒ¼ã‚«ãƒ«CIã¨ã—ã¦ã€ã‚³ãƒŸãƒƒãƒˆå‰ã«ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ

set -e

echo "ğŸ” Running pre-commit checks..."

# Nixé–‹ç™ºç’°å¢ƒãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
if [ -f "flake.nix" ]; then
    # Nixç’°å¢ƒã§Gradleã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
    if command -v nix &> /dev/null; then
        GRADLE_CMD="nix develop -c gradle"
    else
        echo "âŒ Nix not found! Please install Nix or run 'direnv allow'"
        exit 1
    fi
# Gradleãƒ©ãƒƒãƒ‘ãƒ¼ã‚’å„ªå…ˆ
elif [ -f "./gradlew" ]; then
    GRADLE_CMD="./gradlew"
# ã‚·ã‚¹ãƒ†ãƒ ã®Gradleã‚’ä½¿ç”¨
elif command -v gradle &> /dev/null; then
    GRADLE_CMD="gradle"
else
    echo "âŒ Gradle not found!"
    exit 1
fi

# 1. ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆé«˜é€Ÿï¼‰
echo "ğŸ”¨ Checking compilation..."
$GRADLE_CMD compileKotlin compileTestKotlin

# 2. ktlint (ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯)
echo "ğŸ“ Checking code format (ktlint)..."
$GRADLE_CMD ktlintCheck

# 3. detekt (é™çš„è§£æ)
echo "ğŸ” Running static analysis (detekt)..."
$GRADLE_CMD detekt

# 4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¯CIå´ã§å®Ÿæ–½ï¼ˆæ™‚é–“çŸ­ç¸®ã®ãŸã‚ï¼‰
# echo "ğŸ§ª Running tests..."
# $GRADLE_CMD test

# 5. ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ (Phase 1å®Œäº†å¾Œã«æœ‰åŠ¹åŒ–)
# echo "ğŸ“Š Checking test coverage..."
# $GRADLE_CMD jacocoTestCoverageVerification

echo "âœ… All pre-commit checks passed!"
echo "â„¹ï¸  Full test suite will run in CI"
