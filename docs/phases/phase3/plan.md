# Phase 3 詳細計画

**フェーズ目標**: 異なる戦略を比較できるようにする

**成果物**:
- 2つの新しい戦略実装（ランダム戦略、保守的戦略）
- コマンドライン引数で戦略を指定できるCLI
- 各戦略のユニットテスト

**重要方針**:
- **既存の戦略インターフェース（BuyStrategy）を活用**
- Phase 1, 2のコードは維持し、新しい戦略を追加する形で実装
- 戦略切り替えはコマンドライン引数で実現

---

## ⚠️ この計画書の位置づけ

**このドキュメントに書かれているタスク分解や実装内容は「出発点」であり、「確定仕様」ではありません。**

### TDDでの柔軟な計画変更

このドキュメントには詳細なタスク分解と具体的な実装内容が記載されていますが、これらは：

- ✅ **実装の出発点**として活用する
- ✅ **実装中に不要と判断したタスクはスキップする**
- ✅ **新たに必要なタスクが見つかれば追加する**
- ✅ **実装順序も柔軟に変更する**
- ❌ **この通りに実装しなければならない**わけではない

### 実装中の判断例

```
例1: ランダム戦略のパラメータ
→ 実装中に「購入確率は50%固定で十分」と判断したらそのまま実装

例2: 保守的戦略の閾値
→ 実装中に「$500だと厳しすぎる」と判断したら$300に変更

例3: 戦略選択UI
→ 実装中に「コマンドライン引数よりも設定ファイルの方が良い」と判断したら変更
```

**TDDのテストを書きながら、最適なタスク分解と実装順序を見つける。**

---

## L1: Phase 3全体概要

Phase 3では、ゲーム戦略の多様性を実現します。Phase 1で実装したAlwaysBuyStrategy以外に、異なる判断基準を持つ戦略を追加することで、戦略間の比較分析が可能になります。

### Phase 1, 2のコードへの影響

Phase 3では既存コードへの大きな変更は不要です：

1. **戦略インターフェースは既に実装済み**
   - BuyStrategyインターフェースはPhase 1で既に定義済み
   - 新しい戦略はこのインターフェースを実装するだけ

2. **既存コードの変更は最小限**
   - Main.ktに戦略選択機能を追加
   - コマンドライン引数のパース処理を追加

3. **テストコードへの影響**
   - 新しい戦略のユニットテストを追加
   - 既存テストは変更不要

---

## L2: 機能分類

### L2-1: ランダム戦略の実装
購入判断をランダムに行う戦略

### L2-2: 保守的戦略の実装
一定額以上の現金を保持する慎重な戦略

### L2-3: 戦略選択機能
CLIで戦略を指定して実行する機能

### L2-4: テスト
各戦略のユニットテスト

---

## L3: 詳細タスク

### L2-1: ランダム戦略の実装

#### L3-1-1: RandomStrategy実装
- **タスク**: RandomStrategyクラスを作成
- **内容**:
  - BuyStrategyインターフェースを実装
  - shouldBuyメソッドで50%の確率で購入を決定
  - Random.nextBoolean()を使用
  - コンストラクタでRandomインスタンスを受け取る（テスト容易性のため）
- **成果物**: `RandomStrategy.kt`
- **Phase 1, 2への影響**: なし（新規追加）
- **テスト**: 購入判断がランダムであること

---

### L2-2: 保守的戦略の実装

#### L3-2-1: ConservativeStrategy実装
- **タスク**: ConservativeStrategyクラスを作成
- **内容**:
  - BuyStrategyインターフェースを実装
  - 購入後の所持金が閾値（例: $500）以上なら購入
  - 閾値はコンストラクタで設定可能（デフォルト: $500）
  - shouldBuyメソッドで `playerMoney - propertyPrice >= threshold` を判定
- **成果物**: `ConservativeStrategy.kt`
- **Phase 1, 2への影響**: なし（新規追加）
- **テスト**: 閾値以上の現金が残る場合のみ購入すること

---

### L2-3: 戦略選択機能

#### L3-3-1: コマンドライン引数パース
- **タスク**: Main.ktに引数パース機能を追加
- **内容**:
  - `--strategy <strategy-name>` オプションを追加
  - サポートする戦略: always-buy, random, conservative
  - デフォルト: always-buy
  - 不正な戦略名の場合はエラーメッセージを表示
- **成果物**: 更新されたMain.kt
- **Phase 1, 2への影響**: Main.ktの変更（既存機能は維持）
- **テスト**: 手動テスト（各戦略でゲームが実行できること）

#### L3-3-2: 戦略ファクトリー
- **タスク**: 戦略名から戦略インスタンスを生成する関数を作成
- **内容**:
  - `createStrategy(name: String): BuyStrategy` 関数を実装
  - when式で戦略名に応じてインスタンスを返す
  - 不正な戦略名の場合は例外をスロー
- **成果物**: Main.kt内の関数
- **Phase 1, 2への影響**: なし（新規追加）
- **テスト**: 手動テスト

#### L3-3-3: ヘルプメッセージ
- **タスク**: 使用方法を表示するヘルプメッセージを追加
- **内容**:
  - `--help` オプションで戦略一覧と使い方を表示
  - 各戦略の簡単な説明を含める
- **成果物**: 更新されたMain.kt
- **Phase 1, 2への影響**: Main.ktの変更
- **テスト**: 手動テスト

---

### L2-4: テスト

#### L3-4-1: RandomStrategyのテスト
- **タスク**: RandomStrategyのユニットテストを作成
- **内容**:
  - シード固定のRandomを使用してテスト
  - 50%の確率で購入することを検証（複数回実行）
  - shouldBuyメソッドが正しく動作することを確認
- **成果物**: `RandomStrategyTest.kt`
- **Phase 1, 2への影響**: なし
- **テスト**: すべてのテストがパス

#### L3-4-2: ConservativeStrategyのテスト
- **タスク**: ConservativeStrategyのユニットテストを作成
- **内容**:
  - 閾値以上の現金が残る場合のみ購入することを検証
  - 閾値ちょうどの場合を検証
  - 閾値未満の場合は購入しないことを検証
- **成果物**: `ConservativeStrategyTest.kt`
- **Phase 1, 2への影響**: なし
- **テスト**: すべてのテストがパス

#### L3-4-3: 統合テスト
- **タスク**: 各戦略でゲームが完走することを確認
- **内容**:
  - AlwaysBuyStrategy、RandomStrategy、ConservativeStrategyでそれぞれゲームを実行
  - ゲームが最後まで実行され、勝者が決まることを確認
  - 手動テスト: HTMLレポートで各戦略の挙動の違いを確認
- **成果物**: 手動テスト結果
- **Phase 1, 2への影響**: なし
- **テスト**: 各戦略でゲームが完走すること

---

## タスクの優先順位

### 必須タスク（Phase 3 完了に必要）
1. L3-1-1: RandomStrategy実装
2. L3-2-1: ConservativeStrategy実装
3. L3-3-1: コマンドライン引数パース
4. L3-3-2: 戦略ファクトリー
5. L3-4-1 ~ L3-4-3: テスト

### 推奨実装順序

1. **RandomStrategy実装** (L3-1-1) - まずシンプルな戦略から
2. **RandomStrategyのテスト** (L3-4-1) - 動作を確認
3. **ConservativeStrategy実装** (L3-2-1) - 次に閾値ベースの戦略
4. **ConservativeStrategyのテスト** (L3-4-2) - 動作を確認
5. **戦略ファクトリー** (L3-3-2) - 戦略を切り替える仕組み
6. **コマンドライン引数パース** (L3-3-1) - CLIで戦略を選択
7. **ヘルプメッセージ** (L3-3-3) - 使い方を分かりやすく
8. **統合テスト** (L3-4-3) - 全体が動作することを確認

---

## 見積もり

| タスク分類 | 想定時間 |
|-----------|---------|
| L2-1: ランダム戦略の実装 | 1-2時間 |
| L2-2: 保守的戦略の実装 | 1-2時間 |
| L2-3: 戦略選択機能 | 2-3時間 |
| L2-4: テスト | 2-3時間 |
| **合計** | **6-10時間（1-2日）** |

---

## Phase 3完了条件

- [ ] RandomStrategyが実装されている
- [ ] ConservativeStrategyが実装されている
- [ ] コマンドライン引数で戦略を選択できる
- [ ] `--help` で戦略一覧と使い方が表示される
- [ ] 各戦略のユニットテストがパスする
- [ ] 各戦略でゲームが完走する（手動テスト）
- [ ] HTMLレポートで戦略ごとの挙動の違いが確認できる（手動テスト）

---

## 次のアクション

1. **Phase 3設計レビュー**
   - このドキュメントをレビュー
   - 戦略の設計を確認

2. **Phase 3実装開始**
   - L3-1-1からTDD開始
   - シンプルな戦略から実装

---

**作成日**: 2025-11-16
**最終更新**: 2025-11-16
